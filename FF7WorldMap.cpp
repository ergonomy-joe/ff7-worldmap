#include "NEWFF7/ff7.h"
#include "NEWFF7/loadmenu.h"
#include "NEWFF7/menu_data.h"
#include "NEWFF7/field_data.h"

#include <assert.h>
////////////////////////////////////////
int MAIN_frameCount = 0;

int MAIN_inputMask_prev = 0;
int MAIN_inputMask = 0;
int MAIN_triggerMask = 0;
int MAIN_inputMask2 = 0;
////////////////////////////////////////
const char D_007B6658[] = "Software\\Square Soft, Inc.\\Final Fantasy VII\\1.00\\Graphics";
const char D_007B6698[] = "Software\\Square Soft, Inc.\\Final Fantasy VII\\1.00\\Sound";
const char D_007B66D0[] = "Software\\Square Soft, Inc.\\Final Fantasy VII\\1.00\\Midi";
const char D_007B6708[] = "DD_GUID";
const char D_007B6710[] = "MIDI_DeviceID";
const char D_007B6720[] = "Sound_GUID";
////////////////////////////////////////
//Declare this object to satisfy the linker
struct t_battle_progress_info {
	unsigned char __00[0x48];
};
struct t_battle_progress_info D_0099E2C0;
////////////////////////////////////////
//int D_009A06CC = 0;//main.cpp
int D_009A06D0;//debug memory flag[ON/OFF]?

int D_009A85E0 = 0;//from input:trigger mask
//int D_009ACB90 = 1;//from Battle:flag "sys"(tem memory)?

//part of WINDOW.BIN
unsigned char FONTINFO[0x518] = {
	0x03,0x45,0x48,0x0A,0x07,0x0A,0x09,0x03,0x48,0x48,0x07,0x07,0x27,0x05,0x26,0x06,
	0x08,0x47,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x45,0x04,0x07,0x08,0x07,0x27,
	0x0A,0x09,0x07,0x08,0x08,0x07,0x07,0x08,0x08,0x03,0x06,0x07,0x07,0x0B,0x08,0x09,
	0x07,0x09,0x07,0x07,0x07,0x08,0x09,0x0B,0x08,0x09,0x07,0x04,0x06,0x04,0x07,0x08,
	0x04,0x07,0x07,0x06,0x07,0x07,0x06,0x07,0x07,0x03,0x04,0x06,0x03,0x0B,0x07,0x07,
	0x07,0x07,0x05,0x06,0x06,0x07,0x07,0x0B,0x07,0x07,0x06,0x05,0x03,0x05,0x08,0x44,
	0x4B,0x4C,0x4B,0x49,0x4B,0x09,0x08,0x07,0x49,0x07,0x07,0x07,0x07,0x07,0x07,0x07,
	0x07,0x07,0x04,0x03,0x04,0x04,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,
	0x0B,0x06,0x07,0x08,0x0B,0x06,0x07,0x07,0x09,0x2A,0x4D,0x04,0x05,0x08,0x0C,0x09,
	0x0B,0x07,0x07,0x07,0x09,0x07,0x07,0x07,0x09,0x08,0x04,0x06,0x06,0x09,0x0B,0x07,
	0x06,0x03,0x08,0x07,0x08,0x08,0x09,0x07,0x07,0x09,0x01,0x09,0x09,0x09,0x0C,0x0B,
	0x08,0x0C,0x06,0x06,0x04,0x04,0x07,0x07,0x07,0x09,0x07,0x09,0x05,0x05,0x07,0x07,
	0x08,0x03,0x04,0x06,0x0D,0x09,0x07,0x09,0x07,0x07,0x03,0x03,0x03,0x03,0x09,0x09,
	0x08,0x09,0x08,0x08,0x08,0x03,0x06,0x07,0x05,0x06,0x03,0x06,0x05,0x06,0x05,0x05,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
////////////////////////////////////////
//====---- WORLD MAP ----====
extern void C_0074BE49(struct t_aa0 *);//WORLD MAP[UPDATE][callback]
extern void C_0074BA80(int, int, int, struct t_aa0 *);//WORLD MAP[ONMOUSE][callback]
extern void C_0074BA85(int, int, int, struct t_aa0 *);//WORLD MAP[ONKEY][callback]
extern void C_0074BAF5(struct t_aa0 *);//WORLD MAP[BEGIN][callback]
//extern void C_0074BD50(void);//WORLD MAP:clean?
extern void C_0074BD77(struct t_aa0 *);//WORLD MAP[END][callback]
////////////////////////////////////////
//currently inserted CD #?
int C_00404A7D() {
	//TODO
	return 1;
}
////////////////////////////////////////
//from main.cpp
////////////////////////////////////////
//main:open main archives?
int C_004082BF() {
	struct {
		int local_129;
		char local_128[256];
		char local_64[256];
	} lolo;


	//...
	//5 - wm/world_us.lgp
	strcpy(lolo.local_64, D_009A06B4);
	strcat(lolo.local_64, "wm/world_us.lgp");
	if(C_00675511(lolo.local_64, ARCHIVE_05) == 0) {//is_lib:open archive?
		sprintf(lolo.local_128, "Failed to load: %s\n", lolo.local_64);
		C_00664E30(lolo.local_128);
		D_00CBF9DC = 0x13;
		return lolo.local_129;
	}
	//...
	lolo.local_129 = 1;

	return lolo.local_129;
}

//MainDispatcher[MAIN_INIT][callback]
int C_004089C5(struct t_aa0 *bp08) {
	struct {
		char bp_42c[256];
		char bp_32c[256];
		//
		int local_132;
		//...
		int local_130;
		//...
		char local_129[256];
		//...
		char local_64[256];
	}lolo;

	//TODO
	if(C_0067806E(bp08)) {//graphic driver:START?
		//-- init sound system --
		if(D_009A06A0) {
			if(C_00744400(D_009A06A8, D_009A06A4, bp08->f_05c) == 0) {//sound_init?
				D_00CBF9DC = 0x13;
				return 0;
			}
			C_00745CF3(0x2b, 0);//sound:load/prepare SFX?
		}
		//-- init midi system --
		if(D_009A06B0)
			C_00741780(D_009A06AC, bp08->f_05c);//MIDI:init
		//-- open some archives --
		//4 - menu/menu_us.lgp
		strcpy(lolo.local_64, D_009A06B8);
		strcat(lolo.local_64, "menu/menu_us.lgp");
		if(C_00675511(lolo.local_64, ARCHIVE_04) == 0) {//is_lib:open archive?
			sprintf(lolo.local_129, "Failed to load: %s\n", lolo.local_64);
			C_00664E30(lolo.local_129);
			D_00CBF9DC = 0x13;
			return lolo.local_130;
		}
		//...
		//-- --
		if(C_004082BF() == 0)//main:open main archives?
			return 0;
		//-- --
		//...
		lolo.local_132 = CoInitialize(0);
		if(lolo.local_132 < 0)
			C_00414EE0("Failed to initialize COM (0x%8.8X)\n", lolo.local_132);//movie related debug printf?<empty>
#if 1	//##### for WORLD[menu] #####
		C_006C0F60();//init system menu?
#endif
#if 1	//##### for FIELD/WORLD #####
		int fileIndex = 0;
		int saveIndex = 1;
		static char path[256];
		sprintf(path, "%ssave/" "save%02d.ff7", D_009A0698, fileIndex);
		FILE *f = fopen(path, "rb");
		if(f) {
			fseek(f, 9 + saveIndex * sizeof(struct t_loadmenu_10f4), SEEK_SET);
			fread(&D_00DBFD38, sizeof(struct t_loadmenu_10f4), 1, f);
			fclose(f);
		}
		//-- --
		C_0067453A(0);//rsd:set some flag
		//-- --
		extern unsigned char *D_00DB958C;
		D_00DB958C = FONTINFO;
#endif
	}

	return 1;
}

//MainDispatcher[MAIN_CLEAN][callback]
void C_00408EDC(struct t_aa0 *bp08) {
	//TODO
}

//MainDispatcher[BEGIN][callback]
void C_00408FA6(struct t_aa0 *bp08) {
	C_0074BAF5(bp08);//WORLD MAP[BEGIN][callback]
}

//MainDispatcher[END][callback]
void C_004090C7(struct t_aa0 *bp08) {
	C_0074BD77(bp08);//WORLD MAP[END][callback]
}

//MainDispatcher[UPDATE][callback]
void C_004090E6(struct t_aa0 *bp08) {
	MAIN_frameCount ++;
	C_0074BE49(bp08);//WORLD MAP[UPDATE][callback]
}

//on WM_ACTIVATE[callback]
void C_00409CF2(int wParam/*bp08*/, struct t_aa0 *bp0c) {
	//TODO
}

//on WM_DEVICECHANGE[callback]
void C_00409D66(int wParam/*bp08*/, int lParam/*bp0c*/, struct t_aa0 *bp10) {
	//TODO
}

//on <CTRL+Q>?[callback]
int C_00409D7B(struct t_aa0 *bp08) {
	//TODO
	return 1;
}

//MainDispatcher[ONMOUSE][callback]
void C_00409DF1(int uMsg, int wParam, int lParam, struct t_aa0 *bp14) {
	C_0074BA80(uMsg, wParam, lParam, bp14);//WORLD MAP[ONMOUSE][callback]
}

//MainDispatcher[ONKEY][callback]
void C_00409E39(int uMsg, int wParam, int lParam, struct t_aa0 *bp14) {
	//TODO
#if 1
	if(uMsg == WM_KEYDOWN && (HIWORD(lParam) & KF_REPEAT)) {
		return;
	}
	int mask = 0;
	int mask2 = 0;
	switch(wParam) {
		case VK_NUMPAD7: mask = 0x0001; break;
		case VK_NUMPAD1: mask = 0x0002; break;
		case VK_NUMPAD9: mask = 0x0004; break;
		case VK_NUMPAD3: mask = 0x0008; break;
		case VK_ADD: mask = 0x0010; break;
		case VK_RETURN: mask = 0x0020; break;
		case VK_NUMPAD0: mask = 0x0040; break;
		case VK_DECIMAL: mask = 0x0080; break;
		case VK_SUBTRACT: mask = 0x0100; break;
		case VK_NUMPAD5: mask = 0x0800; break;
		case VK_NUMPAD8: mask = 0x1000; break;
		case VK_NUMPAD6: mask = 0x2000; break;
		case VK_NUMPAD2: mask = 0x4000; break;
		case VK_NUMPAD4: mask = 0x8000; break;
		//-- --
		case 'A': mask2 = 0x0001; break;
		case 'B': mask2 = 0x0002; break;
		case 'C': mask2 = 0x0004; break;
		case 'D': mask2 = 0x0008; break;
		case 'E': mask2 = 0x0010; break;
		case 'F': mask2 = 0x0020; break;
		case 'G': mask2 = 0x0040; break;
		case 'H': mask2 = 0x0080; break;
		case 'I': mask2 = 0x0100; break;
		case 'J': mask2 = 0x0200; break;
		case 'K': mask2 = 0x0400; break;
		case 'L': mask2 = 0x0800; break;
		case VK_UP: mask2 = 0x1000; break;
		case VK_RIGHT: mask2 = 0x2000; break;
		case VK_DOWN: mask2 = 0x4000; break;
		case VK_LEFT: mask2 = 0x8000; break;

		//default:
	}
	if(mask) {
		switch(uMsg) {
			case WM_KEYDOWN: MAIN_inputMask |= mask; break;
			case WM_KEYUP: MAIN_inputMask &= ~mask; break;
			case WM_CHAR: break;
			default:
				assert(0);
		}
	}
	if(mask2) {
		switch(uMsg) {
			case WM_KEYDOWN: MAIN_inputMask2 |= mask2; break;
			case WM_KEYUP: MAIN_inputMask2 &= ~mask2; break;
			case WM_CHAR: break;
			default:
				assert(0);
		}
	}
#endif
	C_0074BA85(uMsg, wParam, lParam, bp14);//WORLD MAP[ONKEY][callback]
}

//main:some base init/config?
void C_0040A091(int _p08, int _p0c) {
	struct {
		STARTUPINFO local_104;
		DWORD local_87;
		PROCESS_INFORMATION local_86;
		char local_82[256];
		HKEY hKey;//local_18
		DWORD local_17;
		MEMORYSTATUS local_16;
		DWORD dwType;//local_8
		int is_ok;//local_7
		struct t_aa0 *local_6;
		DWORD cbData;//local_5
		char local_4[16];
	} lolo;

	lolo.is_ok = 1;
	C_006602C1(D_009A06D0);//mem:set debug on/off?
	C_00406D10();//initpath:start?
	//-- we need 50000000 bytes --
	GlobalMemoryStatus(&lolo.local_16);
	if(lolo.local_16.dwAvailPageFile < 50000000L) {
		MessageBox(0, "There is insufficient swap space to play FF7.", "No Swap Space", MB_ICONHAND/*0x10*/);
		C_004073F7();//initpath:clean?
		D_00CBF9DC = 0x13;
	}
	//-- check Graphics."DD_GUID" --
	if(RegOpenKeyEx(HKEY_LOCAL_MACHINE, D_007B6658, 0, KEY_QUERY_VALUE, &lolo.hKey) == 0) {//else 0040A148
		lolo.cbData = 0x10;
		if(RegQueryValueEx(lolo.hKey, D_007B6708, 0, &lolo.dwType, (LPBYTE)lolo.local_4, &lolo.cbData) == 0 && lolo.cbData == 0)
			lolo.is_ok = 0;
		RegCloseKey(lolo.hKey);
	} else {
		lolo.is_ok = 0;
	}
	//-- check Midi."MIDI_DeviceID" --
	if(RegOpenKeyEx(HKEY_LOCAL_MACHINE, D_007B66D0, 0, KEY_QUERY_VALUE, &lolo.hKey) == 0) {
		lolo.cbData = 4;
		if(RegQueryValueEx(lolo.hKey, D_007B6710, 0, &lolo.dwType, (LPBYTE)&lolo.local_17, &lolo.cbData) == 0 && lolo.local_17 == -1)
			lolo.is_ok = 0;
		RegCloseKey(lolo.hKey);
	} else {
		lolo.is_ok = 0;
	}
	//-- check Sound."Sound_GUID" --
	if(RegOpenKeyEx(HKEY_LOCAL_MACHINE, D_007B6698, 0, KEY_QUERY_VALUE, &lolo.hKey) == 0) {
		lolo.cbData = 0x10;
		if(RegQueryValueEx(lolo.hKey, D_007B6720, 0, &lolo.dwType, (LPBYTE)lolo.local_4, &lolo.cbData) == 0 && lolo.cbData == 0)
			lolo.is_ok = 0;
		RegCloseKey(lolo.hKey);
	} else {
		lolo.is_ok = 0;
	}
	//--        if error       --
	//-- lanch "ff7config.exe" --
	if(lolo.is_ok == 0) {//else 0040A34E
		lolo.local_104.cb = 0; memset(&(lolo.local_104.lpReserved), 0, sizeof(STARTUPINFO) - 4);//STARTUPINFO local_104 = {0};
		lolo.local_86.hProcess = 0; memset(&(lolo.local_86.hThread), 0, sizeof(PROCESS_INFORMATION) - 4);//PROCESS_INFORMATION local_86 = {0};

		lolo.local_104.cb = sizeof(STARTUPINFO);//0x44
		lolo.local_104.lpReserved = 0;
		lolo.local_104.lpReserved2 = 0;
		lolo.local_104.cbReserved2 = 0;
		lolo.local_104.lpDesktop = 0;
		lolo.local_104.dwFlags = 0;

		strcpy(lolo.local_82, D_009A0698);
		strcat(lolo.local_82, "ff7config.exe");

		CreateProcess(0, lolo.local_82, 0, 0, TRUE, NORMAL_PRIORITY_CLASS/*0x20*/, 0, 0, &lolo.local_104, &lolo.local_86);
		WaitForSingleObject(lolo.local_86.hProcess, -1);
		GetExitCodeProcess(lolo.local_86.hProcess, &lolo.local_87);
		if(lolo.local_87)
			D_00CBF9DC = 0x13;
	}
	//-- --
	if(C_00404A7D() == 0) {//currently inserted CD #?
		MessageBox(0, "Please insert FF7 Game Disc 1, 2, or 3 and try again.", "Insert Game Disc", MB_ICONHAND/*0x10*/);
		C_004073F7();//initpath:clean?
		D_00CBF9DC = 0x13;
	}
	//-- --
	lolo.local_6 = C_00676E7E();//directx:init some game object?
	if(lolo.local_6) {//else 0040A459
		lolo.local_6->f_99c = 90.0f;
		lolo.local_6->f_9a0 = 125.0f;
		lolo.local_6->f_9a4 = 50000.0f;
		C_004069FD(lolo.local_6);//prepare graphic driver?
		//-- set some major callbacks --
		lolo.local_6->f_9f0.f_00 = C_004089C5;//MainDispatcher[MAIN_INIT][callback]
		lolo.local_6->f_9f0.f_10 = C_004090E6;//MainDispatcher[UPDATE][callback]
		lolo.local_6->f_9f0.f_04 = C_00408EDC;//MainDispatcher[MAIN_CLEAN][callback]
		lolo.local_6->f_9f0.f_08 = C_00408FA6;//MainDispatcher[BEGIN][callback]
		lolo.local_6->f_9f0.f_0c = C_004090C7;//MainDispatcher[END][callback]
		lolo.local_6->f_a28 = C_00409CF2;//on WM_ACTIVATE[callback]
		lolo.local_6->f_a2c = C_00409D66;//on WM_DEVICECHANGE[callback]
		lolo.local_6->f_a58 = C_006C0E2D;//on "Exit box"?[callback]
		lolo.local_6->f_a5c = C_00409D7B;//on <CTRL+Q>?[callback]
		lolo.local_6->f_9f0.f_14 = C_00409DF1;//MainDispatcher[ONMOUSE][callback]
		lolo.local_6->f_9f0.f_18 = C_00409E39;//MainDispatcher[ONKEY][callback]
		C_0067656B(lolo.local_6);//directx:set some game object?
	}
}

//get frame count
int C_0040AC84() {
	//used by world for 2D animation (map, rivers, snow, ...)

	return MAIN_frameCount;
}
////////////////////////////////////////
//from other module
////////////////////////////////////////
//movie related debug printf?<empty>
int C_00414EE0(const char *format, ...) {
	return 0;
}

//Refresh input driver?
void C_0041A21E(struct t_aa0 *bp08) {
	//TODO
	int diff = MAIN_inputMask_prev ^ MAIN_inputMask;
	MAIN_triggerMask = MAIN_inputMask & diff;
	MAIN_inputMask_prev = MAIN_inputMask;

	D_009A85D4 = MAIN_inputMask;
	D_009A85E0 = MAIN_triggerMask;
}

//test input mask[pressed]?
unsigned C_0041AB67(unsigned bp08) {
	//TODO
	return MAIN_inputMask & bp08;
}

//get mouse mask[unused]?
int C_0041B08F() { return 0; }
//get mouse mask[w repeat][unused]?
int C_0041B0CE() { return 0; }

//test input mask[w repeat]?
int C_0041B099(unsigned bp08) {
	//TODO
	return MAIN_inputMask & bp08;
}

//set input repeat parameters
void C_0041B0D8(int bp08, int bp0c) {
	OutputDebugString("C_0041B0D8\n");
}

//test input mask[trigger]?
unsigned C_0041AB74(unsigned bp08) {
	//TODO
	return MAIN_triggerMask & bp08;
}

//some inflate function?[not called yet]
void C_0041CF10(unsigned char *bp08, unsigned char *bp0c) {
	//...
}
////////////////////////////////////////
//unimplemented stuff
////////////////////////////////////////
struct t_combat_static_560 { char __000[0x560]; } D_0099DDA8;

int D_009A85D4 = 0;

unsigned int D_009A85E8[3][25];
unsigned short D_009AAD6C;
struct t_battle_menu_06_B { char __00[6]; } D_009AC354[0x140];

unsigned char D_00C068B4 = 0;
struct t_menu_shop_local___ *D_00C06910 = 0;
unsigned char D_00C06914 = 0;
unsigned short D_00C069B0[3];

unsigned char *C_0041963C(unsigned int bp08, int bp0c, int bp10) { return 0; }
void C_0041A96D() {}
unsigned char *C_0041F55E() { return 0; }
struct DIDEVICEOBJECTDATA *C_0041F5F5() { return 0; }
int C_0041F678() { return 0; }
int C_0041F766() { return 0; }
struct t_input_58 *C_0041F7D8() { return 0; }

void C_005C7336(struct t_loadmenu_charaInfo *bp08) {}
int C_005C81A3(int bp08) { return 0;}
void C_005C84ED() {}
int C_005C8684(int bp08,int bp0c) { return 0;}

void C_005CB127() { /*OutputDebugString(__FUNCTION__);*/ }
void C_005CB2CC(char bp08) { /*OutputDebugString(__FUNCTION__);*/ }

void C_005CD078(unsigned int bp08) {}
////////////////////////////////////////
struct t_script_20 *D_00CBF5E8;
struct t_main_infos *D_00CBF9D8;
short D_00CBF9DC;
char D_00CBFB6C;
short D_00CC0828;
unsigned char D_00CC0888;
void *D_00CC08F0;
unsigned char D_00CC0960[4];
unsigned char D_00CC0964;
short D_00CC0974;
char D_00CC0B64;
int D_00CC0D80;
short D_00CC0D84;
struct t_main_infos D_00CC0D88;
unsigned char D_00CC14D0[1];
short D_00CC15D0;
short D_00CC15D8;
short D_00CC15DC;
int D_00CC1644;
int D_00CC1648;
struct t_script_DialogInfo_30 D_00CFF5B8[8/*or 4?*/];//check

void C_0061C577() {}
////////////////////////////////////////
